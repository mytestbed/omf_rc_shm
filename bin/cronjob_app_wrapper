#!/usr/bin/env ruby

cmd, stdout_f, stderr_f, pid_f, timeout, kill_sig = *ARGV

pid = Process.spawn(cmd, out: [stdout_f, "a"], err: [stderr_f, "a"])

`echo #{pid} >> #{pid_f}`

if timeout > 0
  fork do
    sleep timeout
    Process.kill(kill_sig, pid)
  end
end

waitpid(pid)

`echo Process #{pid} exited with code: #{$?.exitstatus} >> #{stderr_f}`

